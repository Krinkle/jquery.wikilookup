!function(t){t.wikilookup||(t.wikilookup={})}(jQuery),$.wikilookup.tools={getPropValue:function(t,e){for(var i=t||{},s=0;i=i[e[s]],s++,i&&s<e.length;);return i}};var Api=function(t){t=t||{},this.cache={},this.promises={},this.standardURLs={restBase:"https://{{lang}}.wikipedia.org/api/rest_v1/page/summary/{{pageName}}",api:"https://{{lang}}.wikipedia.org/w/api.php"},this.lang=t.lang||"en",this.useRestbase=!!t.useRestbase,this.baseURL=t.baseURL,this.baseURL||(this.baseURL=this.useRestbase?this.standardURLs.restBase:this.standardURLs.api)};Api.prototype.getPageInfo=function(e){var i=this,t=this.getCacheKey(e);return this.cache[t]?$.Deferred().resolve(this.cache[t]):this.promises[t]?this.promises[t]:this.fetch(e).then(function(t){return i.updateCache(e,t),t})},Api.prototype.fetch=function(t){var e,i=this,s=this.getCacheKey(t);return e=$.ajax(this.getApiParams(t)).then(function(t){return i.promises[s]=null,i.processApiResult(t)},function(){return i.promises[s]=null,"error"}).then(function(t){return i.promises[s]=null,"error"===t?$.Deferred().reject("error"):t}),this.promises[s]=e},Api.prototype.processApiResult=function(t){var e,i;return t?this.useRestbase?"https://mediawiki.org/wiki/HyperSwitch/errors/not_found"===t.type?"missing":{title:t.displaytitle,content:t.extract,thumbnail:t.thumbnail||{},url:t.content_urls.desktop.page}:(e=(i=$.wikilookup.tools.getPropValue(t,["query","pages"]))[Object.keys(i)[0]])?{title:e.title,content:e.extract,thumbnail:e.thumbnail,url:e.canonicalurl}:"error":"error"},Api.prototype.updateCache=function(t,e){this.cache[this.getCacheKey(t)]=e},Api.prototype.getCacheKey=function(t){return t.trim().toLowerCase().replace(new RegExp(/\s/g),"_")},Api.prototype.getApiParams=function(t){var e=this.baseURL;return e=e.replace("{{lang}}",encodeURIComponent(this.lang)).replace("{{pageName}}",encodeURIComponent(t)),this.useRestbase?{url:e,data:{redirect:!0}}:{url:e,dataType:"jsonp",data:{action:"query",format:"json",prop:"info|pageimages|extracts",titles:t,inprop:"url",piprop:"thumbnail",pithumbsize:300,redirects:"1",explaintext:"1",exintro:"1"}}},$.wikilookup.Api=Api;var PageInfoWidget=function(t){t=t||{},this.$element=t.$element||$("<div>"),this.messages=$.extend({},{link:"Read more",pending:"Loading...",error:"There was a problem loading this page information."},t.messags),this.$pending=this.buildPending(),this.$view=this.buildView(),this.$error=this.buildError(),this.setState("pending"),this.$element.addClass("wl-pageInfoWidget").append(this.$pending,this.$error,this.$view)};PageInfoWidget.prototype.setState=function(e){var t=["pending","ready","error"];this.state!==e&&-1<t.indexOf(e)&&(t.forEach(function(t){this.$element.toggleClass("wl-pageInfoWidget-state-"+t,e===t)}.bind(this)),this.state=e)},PageInfoWidget.prototype.getState=function(){return this.state},PageInfoWidget.prototype.buildView=function(){return this.$title=$("<h1>").addClass("wl-pageInfoWidget-view-title"),this.$content=$("<div>").addClass("wl-pageInfoWidget-view-content"),this.$thumb=$("<div>").addClass("wl-pageInfoWidget-view-thumb"),this.$link=$("<a>").addClass("wl-pageInfoWidget-view-link").append(this.messages.link),$("<div>").addClass("wl-pageInfoWidget-content-ready").append($("<div>").addClass("wl-pageInfoWidget-box").append(this.$title,this.$content,this.$link),$("<div>").addClass("wl-pageInfoWidget-box").append(this.$thumb))},PageInfoWidget.prototype.setData=function(t){t=$.extend({thumbnail:{}},t),this.$title.text(t.title),this.$content.text(t.content),this.$thumb.css({backgroundImage:"url( "+t.thumbnail.source+" )",width:t.thumbnail.width,height:"100%",backgroundRepeat:"no-repeat",backgroundSize:"cover",backgroundPosition:"center"}),this.$link.attr("href",t.url)},PageInfoWidget.prototype.buildPending=function(){return $("<div>").addClass("wl-pageInfoWidget-content-pending").append(this.messages.pending)},PageInfoWidget.prototype.buildError=function(){return $("<div>").addClass("wl-pageInfoWidget-content-error").append(this.messages.error)},$.wikilookup.PageInfoWidget=PageInfoWidget;var Processor=function(t,e){if(e=e||{},this.$container=t,!this.$container||!this.$container.length)throw new Error("wikilookup initialization error: Could not process given element.");this.prefetch=!!e.prefetch,this.selector=e.selector||"[data-wikilookup]",this.messages=e.messages||{},this.$nodes=$(),this.sources={},this.trigger=null,this.initializeNodes(),this.initializeSources(e.sources),this.setUpdateTrigger(e.trigger),e.prefetch&&this.updateAllNodes()};Processor.prototype.updateAllNodes=function(){var t=this;this.getNodes().each(function(){t.updateWidget($(this))})},Processor.prototype.initializeNodes=function(){var i=this;this.$nodes=this.$container.find(this.selector).filter(function(){return!!($(this).attr("data-wl-title")||$(this).text()).trim()}),this.$nodes.each(function(){var t,e=$(this).attr("data-wl-title")||$(this).text();$(this).attr("data-wl-title",e.trim()),t=new $.wikilookup.PageInfoWidget({messages:i.messages}),$(this).data("wl-widget",t)})},Processor.prototype.getSource=function(t){return t=t||"default",this.sources[t]||(t="default"),this.sources[t]},Processor.prototype.initializeSources=function(t){var e;for(e in t=$.extend({},t),this.sources={default:new $.wikilookup.Api},t)this.sources[e]=new $.wikilookup.Api(t.def)},Processor.prototype.setUpdateTrigger=function(t){var e=this;-1===["click","mouseenter"].indexOf(t)&&(t="click"),this.trigger!==t&&(this.getNodes().each(function(){e.trigger&&e.trigger!==t&&$(this).off(e.trigger+".wikilookupEvent"),$(this).on(t+".wikilookupEvent",e.onTriggerEvent.bind(e,$(this)))}),this.trigger=t)},Processor.prototype.updateWidget=function(t){var e=t.attr("data-wl-title"),i=t.attr("data-wl-source")||"default",s=t.data("wl-widget"),o=!!t.data("wl-state-fetching"),r=this.getSource(i);o||(r?"ready"!==s.getState()&&(t.data("wl-state-fetching",!0),r.getPageInfo(e).then(function(t){s.setData(t),s.setState("ready")},function(){s.setState("error")}).always(function(){t.data("wl-state-fetching",!1)})):console.error('wikilookup error: Could not recognize source "'+i+'".'))},Processor.prototype.onTriggerEvent=function(t){this.updateWidget(t)},Processor.prototype.getNodes=function(){return this.$nodes},Processor.prototype.getAllTerms=function(){var t=[];return this.$nodes.each(function(){t.push($(this).attr("data-wl-title"))}),t},$.wikilookup.Processor=Processor,$.fn.wikilookup=function(t){var e=new $.wikilookup.Processor($(this),t);$(this).data("wl-processor",e)};